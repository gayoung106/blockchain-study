# 자가제한시스템

마이닝에서 채굴 성공한 것을 그냥 두면 안됨

- 체인에 블록을 연결함
  ![iShot_2023-09-27_18 53 22](https://github.com/gayoung106/blockchain-study/assets/98731537/69acf4f1-9c50-481f-9eb1-e2a22a302ec4)

## 일관된 블록 채굴 시간을 유지하기 위해 수행

```js
getDifficulty(difficulty) {
    const lastBlock = this.getLastBlock();


    if (lastBlock.index > 0 && lastBlock.index % 10 === 0) {
      console.log("난이도 조절 시작");
      //이전타임이 필요함
      let prevTime = this.blocks[this.blocks.length - 11].timestamp;
      //마지막(최근)타임
      let lastTime = lastBlock.timestamp;
      //마지막 10개 블록을 채굴하는 데 걸린 평균 시간
      let avgTime = (lastTime - prevTime) / 11 / 1000;
      let multiple = avgTime < 20 ? 4 : 1 / 4;
      difficulty = multiple * difficulty;
      console.log("변경된 난이도", difficulty);
      console.log("난이도 조절 끝");
    }
    return difficulty;
  }
```

- lastBlock의 index가 만약에 11이면? 모듈러 값은 1이 됨, 그러니깐 11, 21, 31 ...단위는 `if문안에 들어가서 동작`하게 됨
- 따라서 `1-10은 바깥으로 나감` (= 기존의 난이도를 주면됨)
- 즉, 나머지가 1인 경우 난이도를 체크해서 변경해줌
- 평균시간은 채굴 난이도 조정 여부를 결정: `avgTime` 을 구해야 함(평균 시간을 구하기 위해 `prevTime`, `lastTime`이 필요)
- `avgTime`이 20초 미만이면 4로 설정되어 난이도가 높아지고, 20이상이면 1/4로 설정되어 난이도를 감소

# 유효성 검증

```js
  isValidBlock(preBlock, newBlock) {
    //1은 genesisBlock을 의미하기 때문에, 유효성 검증을 할 필요 없음
    if (preBlock.index === 1) return 1;
    //3가지 조건이 true여야 함
    return (
      preBlock.index !== 1 &&
      preBlock.hash === newBlock.previousHash &&
      Block.createBlockHash(newBlock) === newBlock.hash
    );
  }
```

- 제네시스 블록이 아니면 true
- 새로운 블록의 이전 해시와 이전블록의 해시가 같으면 true
- 새로운 블록의 해시와해시함수를 통해 해시가 같으면 true

```js
  addBlock(block) {
    //TODO block 유효성 검증을 진행해야함
    const lastBlock = this.getLastBlock();

    if (this.isValidBlock(lastBlock, block)) {
      this.blocks.push(block);
    } else {
      console.log("유효하지 않은 블록입니다.");
    }
  }
```

- 블록 유효성 검증 진행
